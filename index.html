<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#3b82f6">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="HealthIQ">
    <meta name="mobile-web-app-capable" content="yes">
    <title>HealthIQ</title>
    
    <!-- Google Material Symbols Outlined -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogIkhlYWx0aElRIiwKICAic2hvcnRfbmFtZSI6ICJIZWFsdGhJUSIsCiAgImRlc2NyaXB0aW9uIjogIlBlcnNvbmFsIEhlYWx0aCBMb2dnaW5nIEFwcCIsCiAgInN0YXJ0X3VybCI6ICIuLyIsCiAgImRpc3BsYXkiOiAic3RhbmRhbG9uZSIsCiAgImJhY2tncm91bmRfY29sb3IiOiAiI2Y4ZmFmYyIsCiAgInRoZW1lX2NvbG9yIjogIiMzYjgyZjYiLAogICJpY29ucyI6IFsKICAgIHsKICAgICAgInNyYyI6ICJkYXRhOmltYWdlL3N2Zyt4bWw7YmFzZTY0LFBITjJaeUI0Yld4dWN6MGlhSFIwY0RvdkwzZDNkeTUzTXk1dmNtY3ZNakF3TUM5emRtY2lJSGRwWkhSb1BTSXhNREFpSUdobGFXZG9kRDBpTVRBd0lqNDhZMmx5WTJ4bElHTjRQU0kxTUNJZ1kzazlJalV3SWlCeVBTSTBNQ0lnWm1sc2JEMGlJek5pT0RKbU5pSXZQangwWlhoMElIZzlJalV3SWlCNVBTSTFOU0lnZG1GeWFXRnVkQzFpWVhObGJHbHVaVDBpYldsa1pHeGxJaUI0YlMxaGJtTm9iM0k5SW0xcFpHeGxJaUJtYVd4c1BTSWpabVptWm1abUlpQm1iMjUwTFhOcGVtVTlJakV5Y0hnaUlIUmxlSFF0WVc1amFHOXlQU0p0YVdSa2JHVWlQa2hKUEM5MFpYaDBQangwWlhoMElIZzlJalV3SWlCNVBTSTJOaUlnZG1GeWFXRnVkQzFpWVhObGJHbHVaVDBpYldsa1pHeGxJaUI0YlMxaGJtTm9iM0k5SW0xcFpHeGxJaUJtYVd4c1BTSWpabVptWm1abUlpQm1iMjUwTFhOcGVtVTlJakZ3ZUNJZ2RHVjRkQzFoYm1Ob2IzSTlJbTFwWkdSc1pTSStVU0k4TDNSbGVIUStQQzl6ZG1jKyIsCiAgICAgICJzaXplcyI6ICIxMDB4MTAwIiwKICAgICAgInR5cGUiOiAiaW1hZ2Uvc3ZnK3htbCIKICAgIH0KICBdLAogICJvcmllbnRhdGlvbiI6ICJwb3J0cmFpdCIKfQ==">
    
    <!-- App Icons -->
    <link rel="icon" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMDAiIGhlaWdodD0iMTAwIj48Y2lyY2xlIGN4PSI1MCIgY3k9IjUwIiByPSI0MCIgZmlsbD0iIzNiODJmNiIvPjx0ZXh0IHg9IjUwIiB5PSI1NSIgdmFyaWFudC1iYXNlbGluZT0ibWlkZGxlIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmaWxsPSIjZmZmZmZmIiBmb250LXNpemU9IjEycHgiIHRleHQtYW5jaG9yPSJtaWRkbGUiPkhJPC90ZXh0Pjx0ZXh0IHg9IjUwIiB5PSI2NiIgdmFyaWFudC1iYXNlbGluZT0ibWlkZGxlIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmaWxsPSIjZmZmZmZmIiBmb250LXNpemU9IjFweCIgdGV4dC1hbmNob3I9Im1pZGRsZSI+UTwvdGV4dD48L3N2Zz4=">
    <link rel="apple-touch-icon" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMDAiIGhlaWdodD0iMTAwIj48Y2lyY2xlIGN4PSI1MCIgY3k9IjUwIiByPSI0MCIgZmlsbD0iIzNiODJmNiIvPjx0ZXh0IHg9IjUwIiB5PSI1NSIgdmFyaWFudC1iYXNlbGluZT0ibWlkZGxlIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmaWxsPSIjZmZmZmZmIiBmb250LXNpemU9IjEycHgiIHRleHQtYW5jaG9yPSJtaWRkbGUiPkhJPC90ZXh0Pjx0ZXh0IHg9IjUwIiB5PSI2NiIgdmFyaWFudC1iYXNlbGluZT0ibWlkZGxlIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmaWxsPSIjZmZmZmZmIiBmb250LXNpemU9IjFweCIgdGV4dC1hbmNob3I9Im1pZGRsZSI+UTwvdGV4dD48L3N2Zz4=">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #f8fafc;
            height: 100vh;
            overflow: hidden;
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
            padding-left: env(safe-area-inset-left);
            padding-right: env(safe-area-inset-right);
        }

        .container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            padding: 16px;
            gap: 16px;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .header-right {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .app-name {
            font-size: 24px;
            font-weight: 700;
            color: #1f2937;
            letter-spacing: -0.5px;
        }

        .stats {
            display: flex;
            gap: 16px;
            font-size: 14px;
            color: #6b7280;
        }

        .stat {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }

        .stat-number {
            font-size: 18px;
            font-weight: 600;
            color: #3b82f6;
            line-height: 1;
        }

        .stat-label {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-top: 2px;
        }

        .text-area {
            flex: 1;
            width: 100%;
            padding: 20px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 16px;
            font-family: inherit;
            resize: none;
            outline: none;
            background: white;
            color: #334155;
            transition: border-color 0.2s ease;
            -webkit-user-select: text;
            user-select: text;
        }

        .text-area:focus {
            border-color: #3b82f6;
        }

        .text-area::placeholder {
            color: #666;
            font-style: italic;
        }

        .button-container {
            display: flex;
            gap: 12px;
            height: 60px;
        }

        .btn {
            flex: 1;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 44px;
            touch-action: manipulation;
            gap: 6px;
        }

        .btn-log {
            background: #3b82f6;
        }

        .btn-view {
            background: #6b7280;
        }
        
        .btn-health {
            background: #8b5cf6;
        }
        
        .btn-health:hover, .btn-health:active {
            background: #7c3aed;
        }

        .btn:hover, .btn:active {
            transform: translateY(-1px);
            box-shadow: none;
        }

        .btn-log:hover, .btn-log:active {
            background: #2563eb;
        }

        .btn-view:hover, .btn-view:active {
            background: #4b5563;
        }
        
        .btn-header {
            height: auto;
            padding: 8px 12px;
            font-size: 14px;
            gap: 12px;
            min-width: 120px;
            position: relative;
            overflow: hidden;
        }
        
        .btn-stats {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .btn-stat {
            display: flex;
            flex-direction: column;
            align-items: center;
            line-height: 1;
        }
        
        .btn-stat-number {
            font-size: 16px;
            font-weight: 600;
        }
        
        .btn-stat-label {
            font-size: 10px;
            text-transform: uppercase;
            opacity: 0.8;
            margin-top: 2px;
        }
        
        .btn-stat-divider {
            width: 1px;
            height: 24px;
            background: rgba(255, 255, 255, 0.3);
        }
        
        /* Celebration animation */
        @keyframes celebrate {
            0% {
                transform: scale(1);
                background: #6b7280;
            }
            20% {
                transform: scale(1.1);
                background: #10b981;
            }
            100% {
                transform: scale(1);
                background: #6b7280;
            }
        }
        
        .btn-header.celebrating {
            animation: celebrate 5s ease-out;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            padding: 0;
        }

        .modal-content {
            background: white;
            border-radius: 0;
            height: 100%;
            width: 100%;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: none;
            border: none;
        }

        .modal-header {
            display: flex;
            flex-direction: column;
            padding: 20px;
            background: transparent;
            color: #334155;
            border-bottom: none;
        }
        
        .modal-close-row {
            display: flex;
            justify-content: flex-end;
            margin-bottom: 16px;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 600;
            display: flex;
            align-items: center;
        }

        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }

        .modal-btn {
            background: white;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            color: #374151;
            width: 44px;
            height: 44px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            transition: all 0.2s ease;
            touch-action: manipulation;
            min-height: 44px;
            box-shadow: none;
        }
        
        .modal-close-btn {
            background: transparent;
            border: none;
            color: #ef4444;
            font-size: 24px;
            width: 48px;
            height: 48px;
        }
        
        .modal-close-btn:hover {
            background: rgba(239, 68, 68, 0.1);
            border-radius: 50%;
        }

        .modal-btn:hover, .modal-btn:active {
            background: #f9fafb;
            border-color: #9ca3af;
            transform: scale(1.05);
        }
        
        .modal-close-btn:hover, .modal-close-btn:active {
            transform: none;
        }

        .modal-body {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: #fefefe;
            -webkit-overflow-scrolling: touch;
        }

        .log-entry {
            background: white;
            border-radius: 6px;
            padding: 16px;
            margin-bottom: 12px;
            box-shadow: none;
            border: 1px solid #f1f5f9;
            border-left: 3px solid #3b82f6;
        }

        .log-timestamp {
            font-size: 12px;
            color: #666;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .log-content {
            font-size: 14px;
            line-height: 1.5;
            color: #333;
        }

        .empty-state {
            text-align: center;
            color: #666;
            font-style: italic;
            padding: 40px;
        }

        /* Toast notification */
        .toast {
            position: fixed;
            bottom: calc(20px + env(safe-area-inset-bottom));
            left: 50%;
            transform: translateX(-50%);
            background: #374151;
            color: white;
            padding: 12px 20px;
            border-radius: 6px;
            font-size: 14px;
            z-index: 2000;
            opacity: 0;
            transition: opacity 0.3s ease;
            box-shadow: none;
        }

        .toast.show {
            opacity: 1;
        }

        /* Summary table styles */
        .summary-table {
            background: white;
            border-radius: 6px;
            overflow: hidden;
            border: 1px solid #e2e8f0;
        }

        .summary-table table {
            width: 100%;
            border-collapse: collapse;
        }

        .summary-table th {
            background: #f1f5f9;
            padding: 16px;
            text-align: left;
            font-weight: 600;
            color: #374151;
            border-bottom: 1px solid #e2e8f0;
        }

        .summary-table td {
            padding: 12px 16px;
            border-bottom: 1px solid #f1f5f9;
            color: #374151;
        }

        .summary-table tr:last-child td {
            border-bottom: none;
        }

        .summary-count {
            font-weight: 600;
            color: #3b82f6;
        }

        /* PWA Install prompt */
        .install-banner {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: #3b82f6;
            color: white;
            padding: 16px;
            display: none;
            align-items: center;
            justify-content: space-between;
            z-index: 1001;
        }

        .install-banner button {
            background: white;
            color: #3b82f6;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            font-weight: 500;
            cursor: pointer;
        }

        /* Health modal styles */
        .health-textarea {
            width: 100%;
            min-height: 150px;
            padding: 16px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 16px;
            font-family: inherit;
            resize: vertical;
            outline: none;
            background: white;
            color: #334155;
            margin-bottom: 16px;
            -webkit-user-select: text;
            user-select: text;
        }
        
        .health-textarea:focus {
            border-color: #8b5cf6;
        }
        
        .btn-analyze {
            width: 100%;
            background: #8b5cf6;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin-bottom: 20px;
            transition: all 0.2s ease;
        }
        
        .btn-analyze:hover {
            background: #7c3aed;
        }
        
        .btn-analyze:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }
        
        .analysis-result {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
        }
        
        .analysis-result h3 {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 12px;
        }
        
        .log-entry-analysis {
            background: #f0f9ff;
            border: 1px solid #bae6fd;
            border-radius: 6px;
            padding: 12px;
            margin-top: 12px;
            font-size: 14px;
            color: #0369a1;
        }
        
        .log-entry-health {
            background: #faf5ff;
            border: 1px solid #e9d5ff;
            border-radius: 6px;
            padding: 12px;
            margin-top: 8px;
            font-size: 13px;
            color: #6b21a8;
        }
        
        .meta-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 8px;
        }
        
        .meta-tag {
            background: #e0e7ff;
            color: #4338ca;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .manual-prompt-box {
            background: #f3f4f6;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
        }
        
        .manual-prompt-box h4 {
            margin: 0 0 12px 0;
            color: #374151;
            font-size: 16px;
        }
        
        .prompt-text {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            padding: 12px;
            font-family: monospace;
            font-size: 13px;
            white-space: pre-wrap;
            max-height: 200px;
            overflow-y: auto;
            margin-bottom: 12px;
            -webkit-user-select: text;
            user-select: text;
        }
        
        .btn-copy {
            background: #6366f1;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s ease;
        }
        
        .btn-copy:hover {
            background: #4f46e5;
        }
        
        /* Loading screen */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #3b82f6;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            transition: opacity 0.5s ease;
        }

        .loading-screen.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .app-logo {
            width: 80px;
            height: 80px;
            background: white;
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: bold;
            color: #3b82f6;
            margin-bottom: 20px;
        }

        .loading-text {
            color: white;
            font-size: 18px;
            font-weight: 500;
        }
        
        /* Material Symbols Outlined */
        .material-symbols-outlined {
            font-variation-settings:
            'FILL' 0,
            'wght' 400,
            'GRAD' 0,
            'opsz' 24;
            font-size: 20px;
            vertical-align: middle;
            line-height: 1;
        }
        
        /* Icon fallback for offline mode */
        .icon-text {
            display: none;
        }
        
        .offline .material-symbols-outlined {
            display: none;
        }
        
        .offline .icon-text {
            display: inline;
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div class="loading-screen" id="loadingScreen">
        <div class="app-logo">HiQ</div>
        <div class="loading-text">HealthIQ</div>
    </div>

    <!-- Install Banner -->
    <div class="install-banner" id="installBanner">
        <span>Install HealthIQ for the best experience</span>
        <button id="installBtn">Install</button>
    </div>

    <div class="container">
        <div class="header">
            <div class="app-name">HealthIQ</div>
            <div class="header-right">
                <button class="btn btn-health btn-header" id="healthBtn">
                    <span class="material-symbols-outlined">medical_information</span>
                    <span class="icon-text">H</span>
                    Health Issues
                </button>
                <button class="btn btn-view btn-header" id="viewBtn">
                    <span class="material-symbols-outlined" id="viewBtnIcon">visibility</span>
                    <span class="icon-text">></span>
                    <div class="btn-stats">
                        <div class="btn-stat">
                            <span class="btn-stat-number" id="totalCount">0</span>
                            <span class="btn-stat-label">Total</span>
                        </div>
                        <div class="btn-stat-divider"></div>
                        <div class="btn-stat">
                            <span class="btn-stat-number" id="todayCount">0</span>
                            <span class="btn-stat-label">Today</span>
                        </div>
                    </div>
                </button>
            </div>
        </div>
        
        <textarea 
            class="text-area" 
            placeholder="What happened today? Share your thoughts..."
            id="logText"
        ></textarea>
        
        <div class="button-container">
            <button class="btn btn-log" id="logBtn">
                <span class="material-symbols-outlined">add</span>
                <span class="icon-text">+</span>
                Log
            </button>
        </div>
    </div>

    <!-- Modal -->
    <div class="modal" id="logModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-close-row">
                    <button class="modal-btn modal-close-btn" id="closeBtn" title="Close">
                        <span class="material-symbols-outlined">close</span>
                        <span class="icon-text">X</span>
                    </button>
                </div>
                <div class="modal-actions">
                    <button class="modal-btn" id="codeBtn" title="Copy JSON Schema">
                        <span class="material-symbols-outlined">code</span>
                        <span class="icon-text">{}</span>
                    </button>
                    <button class="modal-btn" id="emailBtn" title="Email Log">
                        <span class="material-symbols-outlined">mail</span>
                        <span class="icon-text">@</span>
                    </button>
                    <button class="modal-btn" id="copyBtn" title="Copy as Markdown">
                        <span class="material-symbols-outlined">content_copy</span>
                        <span class="icon-text">C</span>
                    </button>
                    <button class="modal-btn" id="viewMarkdownBtn" title="View as Markdown">
                        <span class="material-symbols-outlined">description</span>
                        <span class="icon-text">Σ</span>
                    </button>
                    <button class="modal-btn" id="summaryBtn" title="Daily Summary">
                        <span class="material-symbols-outlined">analytics</span>
                        <span class="icon-text">☯</span>
                    </button>
                </div>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- Log entries will be inserted here -->
            </div>
        </div>
    </div>

    <!-- Health Issues Modal -->
    <div class="modal" id="healthModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-close-row">
                    <button class="modal-btn modal-close-btn" id="healthCloseBtn" title="Close">
                        <span class="material-symbols-outlined">close</span>
                        <span class="icon-text">X</span>
                    </button>
                </div>
            </div>
            <div class="modal-body" style="padding: 20px;">
                <h2 class="modal-title" style="margin-bottom: 20px;">
                    <span class="material-symbols-outlined" style="margin-right: 8px;">medical_information</span>
                    Health Issues Description
                </h2>
                <textarea 
                    id="healthIssuesText"
                    class="health-textarea"
                    placeholder="Describe your health issues here..."
                ></textarea>
                <button class="btn btn-analyze" id="analyzeHealthBtn">
                    <span class="material-symbols-outlined">psychology</span>
                    Analyze with Claude
                </button>
                <div id="manualAnalysisSection" style="display: none;">
                    <div class="manual-prompt-box">
                        <h4>Copy this prompt to Claude.ai:</h4>
                        <div id="healthPromptText" class="prompt-text"></div>
                        <button class="btn btn-copy" onclick="copyHealthPrompt()">
                            <span class="material-symbols-outlined">content_copy</span>
                            Copy Prompt
                        </button>
                    </div>
                    <textarea 
                        id="healthManualResponse"
                        class="health-textarea"
                        placeholder="Paste Claude's response here..."
                        style="margin-top: 16px;"
                    ></textarea>
                    <button class="btn btn-analyze" onclick="saveHealthAnalysis()">
                        <span class="material-symbols-outlined">save</span>
                        Save Analysis
                    </button>
                </div>
                <div id="healthAnalysisResult" class="analysis-result" style="display: none;">
                    <h3 style="margin-bottom: 12px; color: #374151;">Claude's Analysis</h3>
                    <div id="healthAnalysisContent"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast notification -->
    <div class="toast" id="toast"></div>

    <script>
        // Configuration
        const SPLASH_ANIMATION_TIME = 1500; // milliseconds - adjust this to change loading screen duration
        // Note: API key is now handled by the proxy server using environment variables
        const CLAUDE_PROXY_URL = 'http://localhost:3001/api/claude';
        const CLAUDE_MODEL = 'claude-3-sonnet-20240229';
        
        // Store log entries in localStorage
        let logEntries = [];
        let currentView = 'entries'; // 'entries', 'markdown', 'summary'
        let deferredPrompt;
        let isOffline = false;
        let healthIssues = {
            description: '',
            claudeAnalysis: ''
        };

        // DOM elements
        const logText = document.getElementById('logText');
        const logBtn = document.getElementById('logBtn');
        const viewBtn = document.getElementById('viewBtn');
        const modal = document.getElementById('logModal');
        const modalBody = document.getElementById('modalBody');
        const closeBtn = document.getElementById('closeBtn');
        const copyBtn = document.getElementById('copyBtn');
        const codeBtn = document.getElementById('codeBtn');
        const emailBtn = document.getElementById('emailBtn');
        const viewMarkdownBtn = document.getElementById('viewMarkdownBtn');
        const summaryBtn = document.getElementById('summaryBtn');
        const toast = document.getElementById('toast');
        const totalCountEl = document.getElementById('totalCount');
        const todayCountEl = document.getElementById('todayCount');
        const loadingScreen = document.getElementById('loadingScreen');
        const installBanner = document.getElementById('installBanner');
        const installBtn = document.getElementById('installBtn');
        const healthBtn = document.getElementById('healthBtn');
        const healthModal = document.getElementById('healthModal');
        const healthCloseBtn = document.getElementById('healthCloseBtn');
        const healthIssuesText = document.getElementById('healthIssuesText');
        const analyzeHealthBtn = document.getElementById('analyzeHealthBtn');
        const healthAnalysisResult = document.getElementById('healthAnalysisResult');
        const healthAnalysisContent = document.getElementById('healthAnalysisContent');
        const manualAnalysisSection = document.getElementById('manualAnalysisSection');
        const healthPromptText = document.getElementById('healthPromptText');
        const healthManualResponse = document.getElementById('healthManualResponse');

        // localStorage functions
        function saveToStorage() {
            try {
                localStorage.setItem('healthiq-logs', JSON.stringify(logEntries));
                localStorage.setItem('healthiq-health-issues', JSON.stringify(healthIssues));
            } catch (e) {
                console.error('Failed to save to localStorage:', e);
            }
        }

        function loadFromStorage() {
            try {
                const saved = localStorage.getItem('healthiq-logs');
                if (saved) {
                    logEntries = JSON.parse(saved);
                }
                
                const savedHealth = localStorage.getItem('healthiq-health-issues');
                if (savedHealth) {
                    healthIssues = JSON.parse(savedHealth);
                    if (healthIssues.description) {
                        healthIssuesText.value = healthIssues.description;
                        if (healthIssues.claudeAnalysis) {
                            healthAnalysisContent.innerHTML = healthIssues.claudeAnalysis.replace(/\n/g, '<br>');
                            healthAnalysisResult.style.display = 'block';
                        }
                    }
                }
            } catch (e) {
                console.error('Failed to load from localStorage:', e);
                logEntries = [];
            }
        }

        // PWA Install
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            installBanner.style.display = 'flex';
        });

        installBtn.addEventListener('click', async () => {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                deferredPrompt = null;
                installBanner.style.display = 'none';
            }
        });

        // Service Worker Registration
        if ('serviceWorker' in navigator) {
            const swCode = `
                const CACHE_NAME = 'healthiq-v1';
                const urlsToCache = [];

                self.addEventListener('install', (event) => {
                    event.waitUntil(
                        caches.open(CACHE_NAME)
                            .then((cache) => cache.addAll(urlsToCache))
                    );
                });

                self.addEventListener('fetch', (event) => {
                    event.respondWith(
                        caches.match(event.request)
                            .then((response) => {
                                return response || fetch(event.request);
                            })
                    );
                });
            `;
            
            const blob = new Blob([swCode], { type: 'application/javascript' });
            const swUrl = URL.createObjectURL(blob);
            
            navigator.serviceWorker.register(swUrl)
                .then(() => console.log('SW registered'))
                .catch(() => console.log('SW registration failed'));
        }

        // Add log entry
        logBtn.addEventListener('click', async () => {
            const text = logText.value.trim();
            if (!text) {
                showToast('Please enter some text to log');
                return;
            }

            const entry = {
                timestamp: new Date().toISOString(),
                content: text,
                id: Date.now(),
                healthIssues: healthIssues.description,
                healthAnalysis: healthIssues.claudeAnalysis,
                claudeAnalysis: '',
                metaTags: []
            };

            // Change button to loading state
            logBtn.innerHTML = '<span class="material-symbols-outlined">hourglass_empty</span><span class="icon-text">...</span> Analyzing';
            logBtn.disabled = true;
            
            // Call Claude API if health issues are defined
            if (healthIssues.description) {
                const prompt = createLogEntryPrompt(entry, healthIssues.description, healthIssues.claudeAnalysis);
                const analysis = await callClaudeAPI(prompt);
                
                if (analysis) {
                    entry.claudeAnalysis = analysis;
                    // Extract meta tags from analysis (simple regex approach)
                    const tagMatches = analysis.match(/"([^"]+)"/g);
                    if (tagMatches) {
                        entry.metaTags = tagMatches.map(tag => tag.replace(/"/g, ''));
                    }
                } else {
                    // Use auto-tagging as fallback
                    entry.metaTags = generateAutoTags(entry.content);
                    entry.claudeAnalysis = `Auto-tagged. For full analysis, copy this prompt to Claude.ai:\n\n${prompt}`;
                }
            } else {
                // Auto-tag without health context
                entry.metaTags = generateAutoTags(entry.content);
            }

            logEntries.unshift(entry); // Add to beginning of array
            logText.value = ''; // Clear text area
            saveToStorage(); // Save to localStorage
            
            // Update header stats
            updateStats();
            
            // Change button to checkmark
            logBtn.innerHTML = '<span class="material-symbols-outlined">check</span><span class="icon-text">✓</span> Log';
            logBtn.disabled = false;
            setTimeout(() => {
                logBtn.innerHTML = '<span class="material-symbols-outlined">add</span><span class="icon-text">+</span> Log';
            }, 1000); // Change back after 1 second
            
            // Celebrate in the view button
            celebrateViewButton();
            
            // Return focus to text area
            logText.focus();
        });

        // View log
        viewBtn.addEventListener('click', () => {
            switch(currentView) {
                case 'markdown':
                    renderMarkdownView();
                    break;
                case 'summary':
                    renderSummaryView();
                    break;
                default:
                    renderLogEntries();
            }
            modal.style.display = 'block';
            document.body.style.overflow = 'hidden';
        });

        // Close modal
        closeBtn.addEventListener('click', closeModal);
        modal.addEventListener('click', (e) => {
            if (e.target === modal) closeModal();
        });

        function closeModal() {
            modal.style.display = 'none';
            document.body.style.overflow = 'auto';
        }

        // Copy log to clipboard as Markdown
        copyBtn.addEventListener('click', async () => {
            const markdownData = generateMarkdown(logEntries);
            
            try {
                await navigator.clipboard.writeText(markdownData);
                copyBtn.innerHTML = '<span class="material-symbols-outlined">check</span><span class="icon-text">✓</span>';
                setTimeout(() => {
                    copyBtn.innerHTML = '<span class="material-symbols-outlined">content_copy</span><span class="icon-text">C</span>';
                }, 2000);
            } catch (err) {
                // Fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = markdownData;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                copyBtn.innerHTML = '<span class="material-symbols-outlined">check</span><span class="icon-text">✓</span>';
                setTimeout(() => {
                    copyBtn.innerHTML = '<span class="material-symbols-outlined">content_copy</span><span class="icon-text">C</span>';
                }, 2000);
            }
        });

        // Copy JSON schema to clipboard
        codeBtn.addEventListener('click', async () => {
            const logData = JSON.stringify(logEntries, null, 2);
            
            try {
                await navigator.clipboard.writeText(logData);
                codeBtn.innerHTML = '<span class="material-symbols-outlined">check</span><span class="icon-text">✓</span>';
                setTimeout(() => {
                    codeBtn.innerHTML = '<span class="material-symbols-outlined">code</span><span class="icon-text">{}</span>';
                }, 2000);
            } catch (err) {
                // Fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = logData;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                codeBtn.innerHTML = '<span class="material-symbols-outlined">check</span><span class="icon-text">✓</span>';
                setTimeout(() => {
                    codeBtn.innerHTML = '<span class="material-symbols-outlined">code</span><span class="icon-text">{}</span>';
                }, 2000);
            }
        });

        // Email log
        emailBtn.addEventListener('click', () => {
            const markdownData = generateMarkdown(logEntries);
            const subject = encodeURIComponent('My HealthIQ Log Entries');
            const body = encodeURIComponent(`Here are my HealthIQ log entries:\n\n${markdownData}`);
            const mailtoUrl = `mailto:?subject=${subject}&body=${body}`;
            
            window.location.href = mailtoUrl;
            emailBtn.innerHTML = '<span class="material-symbols-outlined">check</span><span class="icon-text">✓</span>';
            setTimeout(() => {
                emailBtn.innerHTML = '<span class="material-symbols-outlined">mail</span><span class="icon-text">@</span>';
            }, 2000);
        });

        // View as Markdown toggle
        viewMarkdownBtn.addEventListener('click', () => {
            if (currentView === 'markdown') {
                currentView = 'entries';
                renderLogEntries();
            } else {
                currentView = 'markdown';
                renderMarkdownView();
            }
            
            viewMarkdownBtn.innerHTML = '<span class="material-symbols-outlined">check</span><span class="icon-text">✓</span>';
            setTimeout(() => {
                if (currentView === 'markdown') {
                    viewMarkdownBtn.innerHTML = '<span class="material-symbols-outlined">list</span><span class="icon-text">≡</span>';
                } else {
                    viewMarkdownBtn.innerHTML = '<span class="material-symbols-outlined">description</span><span class="icon-text">Σ</span>';
                }
            }, 2000);
        });

        // Daily Summary view
        summaryBtn.addEventListener('click', () => {
            if (currentView === 'summary') {
                currentView = 'entries';
                renderLogEntries();
            } else {
                currentView = 'summary';
                renderSummaryView();
            }
            
            summaryBtn.innerHTML = '<span class="material-symbols-outlined">check</span><span class="icon-text">✓</span>';
            setTimeout(() => {
                if (currentView === 'summary') {
                    summaryBtn.innerHTML = '<span class="material-symbols-outlined">list</span><span class="icon-text">≡</span>';
                } else {
                    summaryBtn.innerHTML = '<span class="material-symbols-outlined">analytics</span><span class="icon-text">☯</span>';
                }
            }, 2000);
        });

        // Render log entries in modal
        function renderLogEntries() {
            if (logEntries.length === 0) {
                modalBody.innerHTML = `
                    <h2 class="modal-title" style="padding: 20px 20px 0; margin-bottom: 20px;">
                        <span class="material-symbols-outlined" style="margin-right: 8px;">list_alt</span>
                        Your Log Entries
                    </h2>
                    <div class="empty-state">No log entries yet. Start logging your thoughts!</div>`;
                return;
            }

            modalBody.innerHTML = `
                <h2 class="modal-title" style="padding: 20px 20px 0; margin-bottom: 20px;">
                    <span class="material-symbols-outlined" style="margin-right: 8px;">list_alt</span>
                    Your Log Entries
                </h2>
                <div style="padding: 0 20px 20px;">
                    ${logEntries.map(entry => `
                <div class="log-entry">
                    <div class="log-timestamp">${formatDate(entry.timestamp)}</div>
                    <div class="log-content">${escapeHtml(entry.content)}</div>
                    ${entry.healthIssues ? `
                        <div class="log-entry-health">
                            <strong>Health Context:</strong> ${escapeHtml(entry.healthIssues)}
                        </div>
                    ` : ''}
                    ${entry.claudeAnalysis ? `
                        <div class="log-entry-analysis">
                            <strong>Claude's Analysis:</strong><br>
                            ${entry.claudeAnalysis.replace(/\n/g, '<br>')}
                        </div>
                    ` : ''}
                    ${entry.metaTags && entry.metaTags.length > 0 ? `
                        <div class="meta-tags">
                            ${entry.metaTags.map(tag => `<span class="meta-tag">${escapeHtml(tag)}</span>`).join('')}
                        </div>
                    ` : ''}
                </div>
            `).join('')}
                </div>`;
        }

        // Render markdown view in modal
        function renderMarkdownView() {
            if (logEntries.length === 0) {
                modalBody.innerHTML = `
                    <h2 class="modal-title" style="padding: 20px 20px 0; margin-bottom: 20px;">
                        <span class="material-symbols-outlined" style="margin-right: 8px;">description</span>
                        Markdown View
                    </h2>
                    <div class="empty-state">No log entries yet. Start logging your thoughts!</div>`;
                return;
            }

            const markdownData = generateMarkdown(logEntries);
            modalBody.innerHTML = `
                <h2 class="modal-title" style="padding: 20px 20px 0; margin-bottom: 20px;">
                    <span class="material-symbols-outlined" style="margin-right: 8px;">description</span>
                    Markdown View
                </h2>
                <div style="background: white; border-radius: 6px; padding: 20px; margin: 0 20px 20px; font-family: monospace; white-space: pre-wrap; font-size: 14px; line-height: 1.6; color: #333; border: 1px solid #e2e8f0;">
                    ${escapeHtml(markdownData)}
                </div>
            `;
        }

        // Render summary view in modal
        function renderSummaryView() {
            if (logEntries.length === 0) {
                modalBody.innerHTML = `
                    <h2 class="modal-title" style="padding: 20px 20px 0; margin-bottom: 20px;">
                        <span class="material-symbols-outlined" style="margin-right: 8px;">analytics</span>
                        Daily Summary
                    </h2>
                    <div class="empty-state">No log entries yet. Start logging your thoughts!</div>`;
                return;
            }

            // Group entries by date
            const entriesByDate = {};
            
            logEntries.forEach(entry => {
                const date = new Date(entry.timestamp);
                const dateKey = date.toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
                
                if (!entriesByDate[dateKey]) {
                    entriesByDate[dateKey] = 0;
                }
                entriesByDate[dateKey]++;
            });

            // Sort dates (most recent first)
            const sortedDates = Object.keys(entriesByDate).sort((a, b) => {
                return new Date(b) - new Date(a);
            });

            const totalEntries = logEntries.length;
            
            modalBody.innerHTML = `
                <h2 class="modal-title" style="padding: 20px 20px 0; margin-bottom: 20px;">
                    <span class="material-symbols-outlined" style="margin-right: 8px;">analytics</span>
                    Daily Summary
                </h2>
                <div class="summary-table" style="margin: 0 20px 20px;">
                    <table>
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Entries</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${sortedDates.map(date => `
                                <tr>
                                    <td>${date}</td>
                                    <td><span class="summary-count">${entriesByDate[date]}</span></td>
                                </tr>
                            `).join('')}
                            <tr style="border-top: 2px solid #e2e8f0; background: #f8fafc;">
                                <td style="font-weight: 600;">Total</td>
                                <td><span class="summary-count" style="font-size: 16px;">${totalEntries}</span></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            `;
        }

        // Utility functions
        function updateStats() {
            const totalCount = logEntries.length;
            const todayCount = getTodayCount();
            
            totalCountEl.textContent = totalCount;
            todayCountEl.textContent = todayCount;
        }

        function getTodayCount() {
            const today = new Date().toDateString();
            return logEntries.filter(entry => {
                const entryDate = new Date(entry.timestamp).toDateString();
                return entryDate === today;
            }).length;
        }

        function generateMarkdown(entries) {
            if (entries.length === 0) {
                return '# My HealthIQ Log Entries\n\nNo entries yet.';
            }

            let markdown = '# My HealthIQ Log Entries\n\n';
            
            entries.forEach((entry, index) => {
                const date = new Date(entry.timestamp);
                const formattedDate = date.toLocaleString('en-US', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });
                
                markdown += `## Entry ${entries.length - index}\n`;
                markdown += `**Date:** ${formattedDate}\n\n`;
                markdown += `${entry.content}\n\n`;
                markdown += '---\n\n';
            });
            
            return markdown.trim();
        }

        function formatDate(isoString) {
            const date = new Date(isoString);
            return date.toLocaleString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function showToast(message) {
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }
        
        function celebrateViewButton() {
            const viewBtnIcon = document.getElementById('viewBtnIcon');
            const viewBtn = document.getElementById('viewBtn');
            
            // Add celebrating class for animation
            viewBtn.classList.add('celebrating');
            
            // Change icon to party face
            viewBtnIcon.textContent = 'celebration';
            
            // After animation completes, restore original state
            setTimeout(() => {
                viewBtn.classList.remove('celebrating');
                viewBtnIcon.textContent = 'visibility';
            }, 5000);
        }
        
        // Claude API functions
        async function callClaudeAPI(prompt) {
            // First try the proxy server
            try {
                const response = await fetch(CLAUDE_PROXY_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: CLAUDE_MODEL,
                        max_tokens: 1024,
                        messages: [{
                            role: 'user',
                            content: prompt
                        }]
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`API Error: ${response.status}`);
                }
                
                const data = await response.json();
                return data.content[0].text;
            } catch (error) {
                // If proxy fails, try direct API (only works on served pages)
                if (window.location.protocol !== 'file:') {
                    try {
                        const response = await fetch(CLAUDE_API_URL, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'x-api-key': CLAUDE_API_KEY,
                                'anthropic-version': '2023-06-01'
                            },
                            body: JSON.stringify({
                                model: CLAUDE_MODEL,
                                max_tokens: 1024,
                                messages: [{
                                    role: 'user',
                                    content: prompt
                                }]
                            })
                        });
                        
                        if (!response.ok) {
                            throw new Error(`API Error: ${response.status}`);
                        }
                        
                        const data = await response.json();
                        return data.content[0].text;
                    } catch (directError) {
                        console.error('Direct API Error:', directError);
                    }
                }
                
                // Fall back to manual mode
                console.error('Claude API Error:', error);
                showToast('API unavailable. Using manual mode.');
                return handleLocalMode(prompt);
            }
        }
        
        function handleLocalMode(prompt, isLogEntry = false) {
            // For local/mobile mode, return null to trigger manual mode
            return null;
        }
        
        function generateAutoTags(text) {
            const lowerText = text.toLowerCase();
            const tags = [];
            
            // Nutrition tags
            if (lowerText.match(/\b(eat|ate|food|meal|breakfast|lunch|dinner|snack|drink|coffee|tea)\b/)) tags.push('nutrition');
            if (lowerText.match(/\b(gluten|dairy|sugar|carb|protein|vegetable|fruit)\b/)) tags.push('diet_specific');
            
            // Exercise tags
            if (lowerText.match(/\b(exercise|walk|run|gym|workout|yoga|stretch|move|physical)\b/)) tags.push('exercise');
            
            // Sleep/Rest tags
            if (lowerText.match(/\b(sleep|slept|nap|rest|tired|fatigue|exhausted|energy)\b/)) tags.push('sleep');
            
            // Emotion tags
            if (lowerText.match(/\b(anxious|anxiety|stress|worried|nervous|calm|happy|sad|depressed|mood)\b/)) tags.push('emotion');
            
            // Physical sensation tags
            if (lowerText.match(/\b(pain|ache|hurt|sore|cramp|headache|migraine|dizzy|nausea)\b/)) tags.push('physical_sensation');
            
            // Symptom tags
            if (lowerText.match(/\b(symptom|flare|crash|relapse|better|worse|improve)\b/)) tags.push('symptom');
            
            // Medication tags
            if (lowerText.match(/\b(medication|medicine|pill|supplement|vitamin|drug)\b/)) tags.push('medication');
            
            return tags;
        }
        
        // Helper functions for manual mode
        function copyHealthPrompt() {
            const promptEl = document.getElementById('healthPromptText');
            const text = promptEl.textContent;
            
            if (navigator.clipboard) {
                navigator.clipboard.writeText(text).then(() => {
                    showToast('Prompt copied! Paste it in Claude.ai');
                }).catch(() => {
                    fallbackCopy(text);
                });
            } else {
                fallbackCopy(text);
            }
        }
        
        function fallbackCopy(text) {
            const textArea = document.createElement('textarea');
            textArea.value = text;
            textArea.style.position = 'fixed';
            textArea.style.opacity = '0';
            document.body.appendChild(textArea);
            textArea.select();
            document.execCommand('copy');
            document.body.removeChild(textArea);
            showToast('Prompt copied!');
        }
        
        function saveHealthAnalysis() {
            const response = healthManualResponse.value.trim();
            if (!response) {
                showToast('Please paste Claude\'s response first');
                return;
            }
            
            healthIssues.description = healthIssuesText.value.trim();
            healthIssues.claudeAnalysis = response;
            healthAnalysisContent.innerHTML = response.replace(/\n/g, '<br>');
            healthAnalysisResult.style.display = 'block';
            manualAnalysisSection.style.display = 'none';
            saveToStorage();
            showToast('Analysis saved!');
        }
        
        window.copyHealthPrompt = copyHealthPrompt;
        window.saveHealthAnalysis = saveHealthAnalysis;
        
        function createHealthIssuesPrompt(description) {
            return `You are a health analysis assistant. A user has provided their health issues description. Please analyze it and provide:

1. A structured summary of their health issues
2. Suggested metadata tags that would be useful for categorizing health logs
3. Key questions they should consider tracking in their logs
4. Any patterns or connections you notice

Health Issues Description:
${description}

Please format your response with clear sections and be concise but comprehensive.`;
        }
        
        function createLogEntryPrompt(logEntry, healthIssues, healthAnalysis) {
            return `You are analyzing a health log entry. The user is tracking their activities and feelings to understand their health issues better.

HEALTH CONTEXT:
User's Health Issues: ${healthIssues}
Previous Analysis: ${healthAnalysis}

NEW LOG ENTRY:
Timestamp: ${new Date(logEntry.timestamp).toLocaleString()}
Content: ${logEntry.content}

Please provide:
1. Relevant observations about this entry in context of their health issues
2. Questions that might help gather more useful data
3. Any nutritional concerns (gluten, sugar, etc.) if food is mentioned
4. Metadata tags for this entry such as: "exercise", "nutrition", "sleep", "emotion", "physical_sensation", "medication", "symptom", etc.
5. Any patterns or connections to their health issues

Format your response with clear sections. Be helpful but concise.`;
        }

        // Health modal handlers
        healthBtn.addEventListener('click', () => {
            healthModal.style.display = 'block';
            document.body.style.overflow = 'hidden';
        });
        
        healthCloseBtn.addEventListener('click', () => {
            healthModal.style.display = 'none';
            document.body.style.overflow = 'auto';
        });
        
        healthModal.addEventListener('click', (e) => {
            if (e.target === healthModal) {
                healthModal.style.display = 'none';
                document.body.style.overflow = 'auto';
            }
        });
        
        analyzeHealthBtn.addEventListener('click', async () => {
            const description = healthIssuesText.value.trim();
            if (!description) {
                showToast('Please describe your health issues first');
                return;
            }
            
            analyzeHealthBtn.disabled = true;
            analyzeHealthBtn.innerHTML = '<span class="material-symbols-outlined">hourglass_empty</span> Analyzing...';
            
            const prompt = createHealthIssuesPrompt(description);
            const analysis = await callClaudeAPI(prompt);
            
            if (analysis) {
                healthIssues.description = description;
                healthIssues.claudeAnalysis = analysis;
                healthAnalysisContent.innerHTML = analysis.replace(/\n/g, '<br>');
                healthAnalysisResult.style.display = 'block';
                manualAnalysisSection.style.display = 'none';
                saveToStorage();
            } else {
                // Show manual mode
                healthPromptText.textContent = prompt;
                manualAnalysisSection.style.display = 'block';
                healthAnalysisResult.style.display = 'none';
                showToast('Please copy the prompt and paste it in Claude.ai');
            }
            
            analyzeHealthBtn.disabled = false;
            analyzeHealthBtn.innerHTML = '<span class="material-symbols-outlined">psychology</span> Analyze with Claude';
        });
        
        // Handle keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                if (modal.style.display === 'block') {
                    closeModal();
                } else if (healthModal.style.display === 'block') {
                    healthModal.style.display = 'none';
                    document.body.style.overflow = 'auto';
                }
            }
        });

        // Check offline status
        function checkOfflineStatus() {
            isOffline = !navigator.onLine;
            if (isOffline) {
                document.body.classList.add('offline');
            } else {
                document.body.classList.remove('offline');
            }
        }
        
        // Initialize app
        window.addEventListener('load', () => {
            // Load data from localStorage
            loadFromStorage();
            updateStats();
            
            // Check offline status
            checkOfflineStatus();
            
            // Hide loading screen
            setTimeout(() => {
                loadingScreen.classList.add('hidden');
                logText.focus();
            }, SPLASH_ANIMATION_TIME);
        });
        
        // Monitor online/offline status
        window.addEventListener('online', checkOfflineStatus);
        window.addEventListener('offline', checkOfflineStatus);

        // Handle visibility change (app pause/resume)
        document.addEventListener('visibilitychange', () => {
            if (!document.hidden) {
                updateStats(); // Refresh stats when app becomes visible
            }
        });

        // Auto-save on page unload
        window.addEventListener('beforeunload', () => {
            saveToStorage();
        });
    </script>
</body>
</html>